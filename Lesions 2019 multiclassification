{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "8c81ecd7",
   "metadata": {
    "_cell_guid": "b1076dfc-b9ad-4769-8c92-a6c4dae69d19",
    "_uuid": "8f2839f25d086af736a60e9eeb907d3b93b6e0e5",
    "execution": {
     "iopub.execute_input": "2024-06-23T12:29:17.996342Z",
     "iopub.status.busy": "2024-06-23T12:29:17.995525Z",
     "iopub.status.idle": "2024-06-23T12:29:23.511220Z",
     "shell.execute_reply": "2024-06-23T12:29:23.510328Z"
    },
    "papermill": {
     "duration": 5.526232,
     "end_time": "2024-06-23T12:29:23.513636",
     "exception": false,
     "start_time": "2024-06-23T12:29:17.987404",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "import torch.nn as nn\n",
    "import torch.optim as optim\n",
    "from torchvision import models, transforms\n",
    "from torch.utils.data import Dataset, DataLoader\n",
    "from PIL import Image\n",
    "import torch\n",
    "import os\n",
    "import pandas as pd\n",
    "import torch.nn.functional as F\n",
    "import numpy as np\n",
    "\n",
    "device = \"cuda\" if torch.cuda.is_available() else \"cpu\""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "298b2a54",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-06-23T12:29:23.528199Z",
     "iopub.status.busy": "2024-06-23T12:29:23.527706Z",
     "iopub.status.idle": "2024-06-23T12:29:23.685538Z",
     "shell.execute_reply": "2024-06-23T12:29:23.684654Z"
    },
    "papermill": {
     "duration": 0.167708,
     "end_time": "2024-06-23T12:29:23.687948",
     "exception": false,
     "start_time": "2024-06-23T12:29:23.520240",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "df_ground_truth = pd.read_csv(\"/kaggle/input/isic-2019/ISIC_2019_Training_GroundTruth.csv\")\n",
    "df_metadata = pd.read_csv(\"/kaggle/input/isic-2019/ISIC_2019_Training_Metadata.csv\")\n",
    "df = pd.merge(df_ground_truth, df_metadata, on='image', how='left')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "23e6255b",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-06-23T12:29:23.702262Z",
     "iopub.status.busy": "2024-06-23T12:29:23.701882Z",
     "iopub.status.idle": "2024-06-23T12:29:23.706072Z",
     "shell.execute_reply": "2024-06-23T12:29:23.705122Z"
    },
    "papermill": {
     "duration": 0.013577,
     "end_time": "2024-06-23T12:29:23.708066",
     "exception": false,
     "start_time": "2024-06-23T12:29:23.694489",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "images_dir = \"/kaggle/input/isic-2019/ISIC_2019_Training_Input/ISIC_2019_Training_Input\""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "b28aac57",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-06-23T12:29:23.722579Z",
     "iopub.status.busy": "2024-06-23T12:29:23.722267Z",
     "iopub.status.idle": "2024-06-23T12:29:23.730383Z",
     "shell.execute_reply": "2024-06-23T12:29:23.729451Z"
    },
    "papermill": {
     "duration": 0.017765,
     "end_time": "2024-06-23T12:29:23.732647",
     "exception": false,
     "start_time": "2024-06-23T12:29:23.714882",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "df = df.drop([\"UNK\", \"lesion_id\"], axis=1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "efd7c7fc",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-06-23T12:29:23.747080Z",
     "iopub.status.busy": "2024-06-23T12:29:23.746779Z",
     "iopub.status.idle": "2024-06-23T12:29:23.774154Z",
     "shell.execute_reply": "2024-06-23T12:29:23.773093Z"
    },
    "papermill": {
     "duration": 0.037257,
     "end_time": "2024-06-23T12:29:23.776345",
     "exception": false,
     "start_time": "2024-06-23T12:29:23.739088",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>image</th>\n",
       "      <th>MEL</th>\n",
       "      <th>NV</th>\n",
       "      <th>BCC</th>\n",
       "      <th>AK</th>\n",
       "      <th>BKL</th>\n",
       "      <th>DF</th>\n",
       "      <th>VASC</th>\n",
       "      <th>SCC</th>\n",
       "      <th>age_approx</th>\n",
       "      <th>anatom_site_general</th>\n",
       "      <th>sex</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>ISIC_0000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>55.0</td>\n",
       "      <td>anterior torso</td>\n",
       "      <td>female</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>ISIC_0000001</td>\n",
       "      <td>0.0</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>30.0</td>\n",
       "      <td>anterior torso</td>\n",
       "      <td>female</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>ISIC_0000002</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>60.0</td>\n",
       "      <td>upper extremity</td>\n",
       "      <td>female</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>ISIC_0000003</td>\n",
       "      <td>0.0</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>30.0</td>\n",
       "      <td>upper extremity</td>\n",
       "      <td>male</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>ISIC_0000004</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>80.0</td>\n",
       "      <td>posterior torso</td>\n",
       "      <td>male</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "          image  MEL   NV  BCC   AK  BKL   DF  VASC  SCC  age_approx  \\\n",
       "0  ISIC_0000000  0.0  1.0  0.0  0.0  0.0  0.0   0.0  0.0        55.0   \n",
       "1  ISIC_0000001  0.0  1.0  0.0  0.0  0.0  0.0   0.0  0.0        30.0   \n",
       "2  ISIC_0000002  1.0  0.0  0.0  0.0  0.0  0.0   0.0  0.0        60.0   \n",
       "3  ISIC_0000003  0.0  1.0  0.0  0.0  0.0  0.0   0.0  0.0        30.0   \n",
       "4  ISIC_0000004  1.0  0.0  0.0  0.0  0.0  0.0   0.0  0.0        80.0   \n",
       "\n",
       "  anatom_site_general     sex  \n",
       "0      anterior torso  female  \n",
       "1      anterior torso  female  \n",
       "2     upper extremity  female  \n",
       "3     upper extremity    male  \n",
       "4     posterior torso    male  "
      ]
     },
     "execution_count": 5,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "e7a12815",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-06-23T12:29:23.791642Z",
     "iopub.status.busy": "2024-06-23T12:29:23.791227Z",
     "iopub.status.idle": "2024-06-23T12:29:23.823274Z",
     "shell.execute_reply": "2024-06-23T12:29:23.822442Z"
    },
    "papermill": {
     "duration": 0.042339,
     "end_time": "2024-06-23T12:29:23.825859",
     "exception": false,
     "start_time": "2024-06-23T12:29:23.783520",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "<class 'pandas.core.frame.DataFrame'>\n",
      "RangeIndex: 25331 entries, 0 to 25330\n",
      "Data columns (total 12 columns):\n",
      " #   Column               Non-Null Count  Dtype  \n",
      "---  ------               --------------  -----  \n",
      " 0   image                25331 non-null  object \n",
      " 1   MEL                  25331 non-null  float64\n",
      " 2   NV                   25331 non-null  float64\n",
      " 3   BCC                  25331 non-null  float64\n",
      " 4   AK                   25331 non-null  float64\n",
      " 5   BKL                  25331 non-null  float64\n",
      " 6   DF                   25331 non-null  float64\n",
      " 7   VASC                 25331 non-null  float64\n",
      " 8   SCC                  25331 non-null  float64\n",
      " 9   age_approx           24894 non-null  float64\n",
      " 10  anatom_site_general  22700 non-null  object \n",
      " 11  sex                  24947 non-null  object \n",
      "dtypes: float64(9), object(3)\n",
      "memory usage: 2.3+ MB\n"
     ]
    }
   ],
   "source": [
    "df.info()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "ffdc3ee9",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-06-23T12:29:23.843663Z",
     "iopub.status.busy": "2024-06-23T12:29:23.843223Z",
     "iopub.status.idle": "2024-06-23T12:29:23.852520Z",
     "shell.execute_reply": "2024-06-23T12:29:23.851393Z"
    },
    "papermill": {
     "duration": 0.020001,
     "end_time": "2024-06-23T12:29:23.855072",
     "exception": false,
     "start_time": "2024-06-23T12:29:23.835071",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/tmp/ipykernel_25/290600658.py:2: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.\n",
      "The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.\n",
      "\n",
      "For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.\n",
      "\n",
      "\n",
      "  df['age_approx'].fillna(median_age, inplace=True)\n"
     ]
    }
   ],
   "source": [
    "median_age = df['age_approx'].median()\n",
    "df['age_approx'].fillna(median_age, inplace=True)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "a63a55fa",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-06-23T12:29:23.872017Z",
     "iopub.status.busy": "2024-06-23T12:29:23.871195Z",
     "iopub.status.idle": "2024-06-23T12:29:23.888877Z",
     "shell.execute_reply": "2024-06-23T12:29:23.888082Z"
    },
    "papermill": {
     "duration": 0.028119,
     "end_time": "2024-06-23T12:29:23.891114",
     "exception": false,
     "start_time": "2024-06-23T12:29:23.862995",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "df.dropna(inplace=True)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "b3e0ee9a",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-06-23T12:29:23.907326Z",
     "iopub.status.busy": "2024-06-23T12:29:23.906514Z",
     "iopub.status.idle": "2024-06-23T12:29:24.789207Z",
     "shell.execute_reply": "2024-06-23T12:29:24.788279Z"
    },
    "papermill": {
     "duration": 0.892897,
     "end_time": "2024-06-23T12:29:24.791594",
     "exception": false,
     "start_time": "2024-06-23T12:29:23.898697",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "from sklearn.preprocessing import OneHotEncoder\n",
    "\n",
    "one_hot = pd.get_dummies(df[[\"anatom_site_general\", \"sex\"]], drop_first=True)\n",
    "\n",
    "df = df.drop([\"anatom_site_general\", \"sex\"], axis=1)\n",
    "df = pd.concat([df, one_hot], axis=1)\n",
    "\n",
    "bool_columns = df.select_dtypes(include=['bool']).columns\n",
    "df[bool_columns] = df[bool_columns].astype(int)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "a7c80c06",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-06-23T12:29:24.807603Z",
     "iopub.status.busy": "2024-06-23T12:29:24.807283Z",
     "iopub.status.idle": "2024-06-23T12:29:24.830702Z",
     "shell.execute_reply": "2024-06-23T12:29:24.829786Z"
    },
    "papermill": {
     "duration": 0.033232,
     "end_time": "2024-06-23T12:29:24.832817",
     "exception": false,
     "start_time": "2024-06-23T12:29:24.799585",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>image</th>\n",
       "      <th>MEL</th>\n",
       "      <th>NV</th>\n",
       "      <th>BCC</th>\n",
       "      <th>AK</th>\n",
       "      <th>BKL</th>\n",
       "      <th>DF</th>\n",
       "      <th>VASC</th>\n",
       "      <th>SCC</th>\n",
       "      <th>age_approx</th>\n",
       "      <th>anatom_site_general_head/neck</th>\n",
       "      <th>anatom_site_general_lateral torso</th>\n",
       "      <th>anatom_site_general_lower extremity</th>\n",
       "      <th>anatom_site_general_oral/genital</th>\n",
       "      <th>anatom_site_general_palms/soles</th>\n",
       "      <th>anatom_site_general_posterior torso</th>\n",
       "      <th>anatom_site_general_upper extremity</th>\n",
       "      <th>sex_male</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>ISIC_0000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>55.0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>ISIC_0000001</td>\n",
       "      <td>0.0</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>30.0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>ISIC_0000002</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>60.0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>ISIC_0000003</td>\n",
       "      <td>0.0</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>30.0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>ISIC_0000004</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>80.0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "          image  MEL   NV  BCC   AK  BKL   DF  VASC  SCC  age_approx  \\\n",
       "0  ISIC_0000000  0.0  1.0  0.0  0.0  0.0  0.0   0.0  0.0        55.0   \n",
       "1  ISIC_0000001  0.0  1.0  0.0  0.0  0.0  0.0   0.0  0.0        30.0   \n",
       "2  ISIC_0000002  1.0  0.0  0.0  0.0  0.0  0.0   0.0  0.0        60.0   \n",
       "3  ISIC_0000003  0.0  1.0  0.0  0.0  0.0  0.0   0.0  0.0        30.0   \n",
       "4  ISIC_0000004  1.0  0.0  0.0  0.0  0.0  0.0   0.0  0.0        80.0   \n",
       "\n",
       "   anatom_site_general_head/neck  anatom_site_general_lateral torso  \\\n",
       "0                              0                                  0   \n",
       "1                              0                                  0   \n",
       "2                              0                                  0   \n",
       "3                              0                                  0   \n",
       "4                              0                                  0   \n",
       "\n",
       "   anatom_site_general_lower extremity  anatom_site_general_oral/genital  \\\n",
       "0                                    0                                 0   \n",
       "1                                    0                                 0   \n",
       "2                                    0                                 0   \n",
       "3                                    0                                 0   \n",
       "4                                    0                                 0   \n",
       "\n",
       "   anatom_site_general_palms/soles  anatom_site_general_posterior torso  \\\n",
       "0                                0                                    0   \n",
       "1                                0                                    0   \n",
       "2                                0                                    0   \n",
       "3                                0                                    0   \n",
       "4                                0                                    1   \n",
       "\n",
       "   anatom_site_general_upper extremity  sex_male  \n",
       "0                                    0         0  \n",
       "1                                    0         0  \n",
       "2                                    1         0  \n",
       "3                                    1         1  \n",
       "4                                    0         1  "
      ]
     },
     "execution_count": 10,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "de2c8b37",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-06-23T12:29:24.848017Z",
     "iopub.status.busy": "2024-06-23T12:29:24.847691Z",
     "iopub.status.idle": "2024-06-23T12:29:24.950603Z",
     "shell.execute_reply": "2024-06-23T12:29:24.949466Z"
    },
    "papermill": {
     "duration": 0.113001,
     "end_time": "2024-06-23T12:29:24.952767",
     "exception": false,
     "start_time": "2024-06-23T12:29:24.839766",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Train set size: 14419\n",
      "Validation set size: 3605\n",
      "Test set size: 4507\n"
     ]
    }
   ],
   "source": [
    "from sklearn.model_selection import train_test_split\n",
    "\n",
    "train_val_df, test_df = train_test_split(df, test_size=0.2, random_state=42, stratify=df['MEL'])\n",
    "\n",
    "# Then, split the training+validation set into training and validation sets\n",
    "train_df, val_df = train_test_split(train_val_df, test_size=0.2, random_state=42, stratify=train_val_df['MEL'])\n",
    "\n",
    "print(f\"Train set size: {len(train_df)}\")\n",
    "print(f\"Validation set size: {len(val_df)}\")\n",
    "print(f\"Test set size: {len(test_df)}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "f8e10b4c",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-06-23T12:29:24.967819Z",
     "iopub.status.busy": "2024-06-23T12:29:24.967511Z",
     "iopub.status.idle": "2024-06-23T12:29:24.975189Z",
     "shell.execute_reply": "2024-06-23T12:29:24.974336Z"
    },
    "papermill": {
     "duration": 0.017362,
     "end_time": "2024-06-23T12:29:24.977041",
     "exception": false,
     "start_time": "2024-06-23T12:29:24.959679",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "class MelanomaDataset(Dataset):\n",
    "    def __init__(self, df, img_dir, transform):\n",
    "        self.img_dir = img_dir\n",
    "        self.df = df\n",
    "        self.transform = transform\n",
    "\n",
    "    def __len__(self):\n",
    "        return len(self.df)\n",
    "\n",
    "    def __getitem__(self, idx):\n",
    "        img_name = os.path.join(self.img_dir, self.df.iloc[idx, 0] + '.jpg')  # Assuming .jpg extension\n",
    "        image = Image.open(img_name)\n",
    "        if transform:\n",
    "            image = self.transform(image)\n",
    "        values = np.array(self.df.iloc[idx, 9:].values, dtype=np.float32)\n",
    "        \n",
    "        characteristics = torch.tensor(values, dtype=torch.float32)\n",
    "        label = torch.tensor(self.df.iloc[idx, 1:9], dtype=torch.float32)\n",
    "        return image, characteristics, label\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "87de8408",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-06-23T12:29:24.991871Z",
     "iopub.status.busy": "2024-06-23T12:29:24.991548Z",
     "iopub.status.idle": "2024-06-23T12:29:24.996482Z",
     "shell.execute_reply": "2024-06-23T12:29:24.995611Z"
    },
    "papermill": {
     "duration": 0.014418,
     "end_time": "2024-06-23T12:29:24.998326",
     "exception": false,
     "start_time": "2024-06-23T12:29:24.983908",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "transform = transforms.Compose([\n",
    "    transforms.Resize((256, 256)),  # Resize to match input size of the model\n",
    "    transforms.ToTensor(),\n",
    "    transforms.Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225]),\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "6972905b",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-06-23T12:29:25.013428Z",
     "iopub.status.busy": "2024-06-23T12:29:25.012691Z",
     "iopub.status.idle": "2024-06-23T12:29:25.018296Z",
     "shell.execute_reply": "2024-06-23T12:29:25.017454Z"
    },
    "papermill": {
     "duration": 0.014999,
     "end_time": "2024-06-23T12:29:25.020161",
     "exception": false,
     "start_time": "2024-06-23T12:29:25.005162",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "train_dataset = MelanomaDataset(train_df, images_dir, transform)\n",
    "val_dataset = MelanomaDataset(val_df, images_dir, transform)\n",
    "test_dataset = MelanomaDataset(test_df, images_dir, transform)\n",
    "\n",
    "# Create DataLoader for each dataset\n",
    "train_loader = DataLoader(train_dataset, batch_size=128, shuffle=True)\n",
    "val_loader = DataLoader(val_dataset, batch_size=128, shuffle=False)\n",
    "test_loader = DataLoader(test_dataset, batch_size=128, shuffle=False)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "1bfa54fb",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-06-23T12:29:25.034647Z",
     "iopub.status.busy": "2024-06-23T12:29:25.034408Z",
     "iopub.status.idle": "2024-06-23T12:29:25.041898Z",
     "shell.execute_reply": "2024-06-23T12:29:25.041028Z"
    },
    "papermill": {
     "duration": 0.016846,
     "end_time": "2024-06-23T12:29:25.043710",
     "exception": false,
     "start_time": "2024-06-23T12:29:25.026864",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "class CombinedModel(nn.Module):\n",
    "    def __init__(self, num_tabular_features):\n",
    "        super(CombinedModel, self).__init__()\n",
    "        self.cnn = models.resnet18(weights=True)\n",
    "        self.cnn.fc = nn.Identity()  # Remove the final classification layer\n",
    "        \n",
    "        self.tabular_fc1 = nn.Linear(num_tabular_features, 128)\n",
    "        self.tabular_fc2 = nn.Linear(128, 64)\n",
    "        \n",
    "        self.fc1 = nn.Linear(512 + 64, 128)  # Combining CNN and tabular features\n",
    "        self.fc2 = nn.Linear(128, 8)  # Assuming binary classification\n",
    "\n",
    "    def forward(self, image, tabular_data):\n",
    "        cnn_features = self.cnn(image)\n",
    "        \n",
    "        tabular_out = nn.ReLU()(self.tabular_fc1(tabular_data))\n",
    "        tabular_out = nn.ReLU()(self.tabular_fc2(tabular_out))\n",
    "        \n",
    "        combined_features = torch.cat((cnn_features, tabular_out), dim=1)\n",
    "        x = nn.ReLU()(self.fc1(combined_features))\n",
    "        x = self.fc2(x)\n",
    "        \n",
    "        return x"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "id": "84b5adc3",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-06-23T12:29:25.058457Z",
     "iopub.status.busy": "2024-06-23T12:29:25.058187Z",
     "iopub.status.idle": "2024-06-23T12:29:25.557289Z",
     "shell.execute_reply": "2024-06-23T12:29:25.556306Z"
    },
    "papermill": {
     "duration": 0.509345,
     "end_time": "2024-06-23T12:29:25.559711",
     "exception": false,
     "start_time": "2024-06-23T12:29:25.050366",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "tensor([0.0182, 0.0074, 0.0244, 0.0938, 0.0339, 0.3374, 0.3572, 0.1275],\n",
       "       device='cuda:0')"
      ]
     },
     "execution_count": 16,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "import torch\n",
    "import torch.nn as nn\n",
    "\n",
    "A = np.array([df[cls].sum() for cls in df.columns[1:9]])\n",
    "\n",
    "class_weights = len(df) / A\n",
    "weights_tensor = torch.tensor(class_weights, dtype=torch.float).to(device)\n",
    "\n",
    "normalized_weights_tensor = (1/sum(weights_tensor)) * weights_tensor\n",
    "normalized_weights_tensor"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "id": "746bf05d",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-06-23T12:29:25.575925Z",
     "iopub.status.busy": "2024-06-23T12:29:25.575567Z",
     "iopub.status.idle": "2024-06-23T12:29:26.303343Z",
     "shell.execute_reply": "2024-06-23T12:29:26.302576Z"
    },
    "papermill": {
     "duration": 0.738171,
     "end_time": "2024-06-23T12:29:26.305375",
     "exception": false,
     "start_time": "2024-06-23T12:29:25.567204",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "9\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/opt/conda/lib/python3.10/site-packages/torchvision/models/_utils.py:223: UserWarning: Arguments other than a weight enum or `None` for 'weights' are deprecated since 0.13 and may be removed in the future. The current behavior is equivalent to passing `weights=ResNet18_Weights.IMAGENET1K_V1`. You can also use `weights=ResNet18_Weights.DEFAULT` to get the most up-to-date weights.\n",
      "  warnings.warn(msg)\n",
      "Downloading: \"https://download.pytorch.org/models/resnet18-f37072fd.pth\" to /root/.cache/torch/hub/checkpoints/resnet18-f37072fd.pth\n",
      "100%|██████████| 44.7M/44.7M [00:00<00:00, 140MB/s]\n"
     ]
    }
   ],
   "source": [
    "num_tabular_features = len(df.columns[9:])\n",
    "print(num_tabular_features)\n",
    "\n",
    "criterion = nn.CrossEntropyLoss(weight=normalized_weights_tensor) \n",
    "model = CombinedModel(num_tabular_features).to(device)\n",
    "optimizer = optim.Adam(lr=0.001, params=model.parameters())"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "id": "e9958442",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-06-23T12:29:26.322680Z",
     "iopub.status.busy": "2024-06-23T12:29:26.322411Z",
     "iopub.status.idle": "2024-06-23T13:24:28.982803Z",
     "shell.execute_reply": "2024-06-23T13:24:28.981876Z"
    },
    "papermill": {
     "duration": 3302.683051,
     "end_time": "2024-06-23T13:24:28.996523",
     "exception": false,
     "start_time": "2024-06-23T12:29:26.313472",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/tmp/ipykernel_25/2271171968.py:18: FutureWarning: Series.__getitem__ treating keys as positions is deprecated. In a future version, integer keys will always be treated as labels (consistent with DataFrame behavior). To access a value by position, use `ser.iloc[pos]`\n",
      "  label = torch.tensor(self.df.iloc[idx, 1:9], dtype=torch.float32)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Epoch [1/10], Step [0], Loss: 0.0465\n",
      "Epoch [1/10], Step [50], Loss: 0.0408\n",
      "Epoch [1/10], Step [100], Loss: 0.0495\n",
      "Epoch [1/10], Average Training Loss: 0.0459\n",
      "Epoch [1/10], Validation Loss: 0.0461, Validation Accuracy: 47.38%\n",
      "Epoch [2/10], Step [0], Loss: 0.0418\n",
      "Epoch [2/10], Step [50], Loss: 0.0292\n",
      "Epoch [2/10], Step [100], Loss: 0.0286\n",
      "Epoch [2/10], Average Training Loss: 0.0409\n",
      "Epoch [2/10], Validation Loss: 0.0553, Validation Accuracy: 17.17%\n",
      "Epoch [3/10], Step [0], Loss: 0.0356\n",
      "Epoch [3/10], Step [50], Loss: 0.0415\n",
      "Epoch [3/10], Step [100], Loss: 0.0277\n",
      "Epoch [3/10], Average Training Loss: 0.0367\n",
      "Epoch [3/10], Validation Loss: 0.0386, Validation Accuracy: 53.90%\n",
      "Epoch [4/10], Step [0], Loss: 0.0288\n",
      "Epoch [4/10], Step [50], Loss: 0.0330\n",
      "Epoch [4/10], Step [100], Loss: 0.0290\n",
      "Epoch [4/10], Average Training Loss: 0.0344\n",
      "Epoch [4/10], Validation Loss: 0.0688, Validation Accuracy: 45.63%\n",
      "Epoch [5/10], Step [0], Loss: 0.0495\n",
      "Epoch [5/10], Step [50], Loss: 0.0333\n",
      "Epoch [5/10], Step [100], Loss: 0.0315\n",
      "Epoch [5/10], Average Training Loss: 0.0336\n",
      "Epoch [5/10], Validation Loss: 0.0386, Validation Accuracy: 60.28%\n",
      "Epoch [6/10], Step [0], Loss: 0.0245\n",
      "Epoch [6/10], Step [50], Loss: 0.0285\n",
      "Epoch [6/10], Step [100], Loss: 0.0309\n",
      "Epoch [6/10], Average Training Loss: 0.0301\n",
      "Epoch [6/10], Validation Loss: 0.0353, Validation Accuracy: 50.37%\n",
      "Epoch [7/10], Step [0], Loss: 0.0361\n",
      "Epoch [7/10], Step [50], Loss: 0.0265\n",
      "Epoch [7/10], Step [100], Loss: 0.0378\n",
      "Epoch [7/10], Average Training Loss: 0.0276\n",
      "Epoch [7/10], Validation Loss: 0.0383, Validation Accuracy: 51.93%\n",
      "Epoch [8/10], Step [0], Loss: 0.0266\n",
      "Epoch [8/10], Step [50], Loss: 0.0235\n",
      "Epoch [8/10], Step [100], Loss: 0.0212\n",
      "Epoch [8/10], Average Training Loss: 0.0255\n",
      "Epoch [8/10], Validation Loss: 0.0413, Validation Accuracy: 52.98%\n",
      "Epoch [9/10], Step [0], Loss: 0.0222\n",
      "Epoch [9/10], Step [50], Loss: 0.0187\n",
      "Epoch [9/10], Step [100], Loss: 0.0170\n",
      "Epoch [9/10], Average Training Loss: 0.0217\n",
      "Epoch [9/10], Validation Loss: 0.0392, Validation Accuracy: 55.84%\n",
      "Epoch [10/10], Step [0], Loss: 0.0203\n",
      "Epoch [10/10], Step [50], Loss: 0.0156\n",
      "Epoch [10/10], Step [100], Loss: 0.0342\n",
      "Epoch [10/10], Average Training Loss: 0.0214\n",
      "Epoch [10/10], Validation Loss: 0.0468, Validation Accuracy: 53.68%\n"
     ]
    }
   ],
   "source": [
    "num_epochs = 10\n",
    "\n",
    "for epoch in range(num_epochs):\n",
    "    model.train()\n",
    "    running_loss = 0.0\n",
    "    for batch_idx, (images, tabular_data, labels) in enumerate(train_loader):\n",
    "        images, tabular_data, labels = images.to(device), tabular_data.to(device), labels.to(device)\n",
    "        optimizer.zero_grad()\n",
    "        outputs = model(images, tabular_data)\n",
    "        loss = criterion(outputs, labels)\n",
    "        loss.backward()\n",
    "        optimizer.step()\n",
    "        \n",
    "        running_loss += loss.item()\n",
    "        if batch_idx % 50 == 0:\n",
    "            print(f'Epoch [{epoch+1}/{num_epochs}], Step [{batch_idx}], Loss: {loss.item():.4f}')\n",
    "    \n",
    "    avg_train_loss = running_loss / len(train_loader)\n",
    "    print(f'Epoch [{epoch+1}/{num_epochs}], Average Training Loss: {avg_train_loss:.4f}')\n",
    "    \n",
    "    # Validation loop\n",
    "    model.eval()\n",
    "    val_running_loss = 0.0\n",
    "    correct = 0\n",
    "    total = 0\n",
    "\n",
    "    with torch.no_grad():\n",
    "        for batch_idx, (images, tabular_data, labels) in enumerate(val_loader):\n",
    "            images, tabular_data, labels = images.to(device), tabular_data.to(device), labels.to(device)\n",
    "            outputs = model(images, tabular_data)\n",
    "            val_loss = criterion(outputs, labels)\n",
    "            val_running_loss += val_loss.item()\n",
    "\n",
    "            # Convert one-hot encoded ground truth labels to class indices\n",
    "            true_labels = torch.argmax(labels, dim=1)\n",
    "\n",
    "            # Get the predicted class indices\n",
    "            predicted_labels = torch.argmax(outputs, dim=1)\n",
    "\n",
    "            total += labels.size(0)\n",
    "            correct += (predicted_labels == true_labels).sum().item()\n",
    "    \n",
    "    avg_val_loss = val_running_loss / len(val_loader)\n",
    "    val_accuracy = 100 * correct / total\n",
    "    print(f'Epoch [{epoch+1}/{num_epochs}], Validation Loss: {avg_val_loss:.4f}, Validation Accuracy: {val_accuracy:.2f}%')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 19,
   "id": "4518bad1",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-06-23T13:24:29.022003Z",
     "iopub.status.busy": "2024-06-23T13:24:29.021612Z",
     "iopub.status.idle": "2024-06-23T13:26:36.151739Z",
     "shell.execute_reply": "2024-06-23T13:26:36.150793Z"
    },
    "papermill": {
     "duration": 127.15723,
     "end_time": "2024-06-23T13:26:36.166033",
     "exception": false,
     "start_time": "2024-06-23T13:24:29.008803",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/tmp/ipykernel_25/2271171968.py:18: FutureWarning: Series.__getitem__ treating keys as positions is deprecated. In a future version, integer keys will always be treated as labels (consistent with DataFrame behavior). To access a value by position, use `ser.iloc[pos]`\n",
      "  label = torch.tensor(self.df.iloc[idx, 1:9], dtype=torch.float32)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Epoch [10/10], Test Loss: 0.0434, Test Accuracy: 51.81%\n"
     ]
    }
   ],
   "source": [
    "model.eval()\n",
    "test_running_loss = 0.0\n",
    "correct = 0\n",
    "total = 0\n",
    "with torch.no_grad():\n",
    "    for idx, (images, tabular_data, labels) in enumerate(test_loader):\n",
    "        images, tabular_data, labels = images.to(device), tabular_data.to(device), labels.to(device)\n",
    "        outputs = model(images, tabular_data)\n",
    "        test_loss = criterion(outputs, labels)\n",
    "        test_running_loss += test_loss.item()\n",
    "\n",
    "        true_labels = torch.argmax(labels, dim=1)\n",
    "\n",
    "        predicted_labels = torch.argmax(outputs, dim=1)\n",
    "\n",
    "        total += labels.size(0)\n",
    "        correct += (predicted_labels == true_labels).sum().item()\n",
    "\n",
    "        \n",
    "avg_test_loss = test_running_loss / len(test_loader)\n",
    "test_accuracy = 100 * correct / total\n",
    "print(f'Epoch [{epoch+1}/{num_epochs}], Test Loss: {avg_test_loss:.4f}, Test Accuracy: {test_accuracy:.2f}%')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 20,
   "id": "b3846cef",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-06-23T13:26:36.191348Z",
     "iopub.status.busy": "2024-06-23T13:26:36.190999Z",
     "iopub.status.idle": "2024-06-23T13:26:36.195155Z",
     "shell.execute_reply": "2024-06-23T13:26:36.194332Z"
    },
    "papermill": {
     "duration": 0.019094,
     "end_time": "2024-06-23T13:26:36.197050",
     "exception": false,
     "start_time": "2024-06-23T13:26:36.177956",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#Test set on image input (256*256*3 with weights frequency_based and batch size 128): 67.34%\n",
    "#Test set on image input (256*256*3 without weights and batch size 128): 67.03%"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 21,
   "id": "ff46ff51",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-06-23T13:26:36.222360Z",
     "iopub.status.busy": "2024-06-23T13:26:36.222040Z",
     "iopub.status.idle": "2024-06-23T13:26:37.235766Z",
     "shell.execute_reply": "2024-06-23T13:26:37.234533Z"
    },
    "papermill": {
     "duration": 1.029347,
     "end_time": "2024-06-23T13:26:37.238386",
     "exception": false,
     "start_time": "2024-06-23T13:26:36.209039",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Sun Jun 23 13:26:37 2024       \r\n",
      "+---------------------------------------------------------------------------------------+\r\n",
      "| NVIDIA-SMI 535.129.03             Driver Version: 535.129.03   CUDA Version: 12.2     |\r\n",
      "|-----------------------------------------+----------------------+----------------------+\r\n",
      "| GPU  Name                 Persistence-M | Bus-Id        Disp.A | Volatile Uncorr. ECC |\r\n",
      "| Fan  Temp   Perf          Pwr:Usage/Cap |         Memory-Usage | GPU-Util  Compute M. |\r\n",
      "|                                         |                      |               MIG M. |\r\n",
      "|=========================================+======================+======================|\r\n",
      "|   0  Tesla P100-PCIE-16GB           Off | 00000000:00:04.0 Off |                    0 |\r\n",
      "| N/A   39C    P0              37W / 250W |   5238MiB / 16384MiB |      0%      Default |\r\n",
      "|                                         |                      |                  N/A |\r\n",
      "+-----------------------------------------+----------------------+----------------------+\r\n",
      "                                                                                         \r\n",
      "+---------------------------------------------------------------------------------------+\r\n",
      "| Processes:                                                                            |\r\n",
      "|  GPU   GI   CI        PID   Type   Process name                            GPU Memory |\r\n",
      "|        ID   ID                                                             Usage      |\r\n",
      "|=======================================================================================|\r\n",
      "+---------------------------------------------------------------------------------------+\r\n"
     ]
    }
   ],
   "source": [
    "!nvidia-smi"
   ]
  }
 ],
 "metadata": {
  "kaggle": {
   "accelerator": "gpu",
   "dataSources": [
    {
     "datasetId": 679322,
     "sourceId": 1193409,
     "sourceType": "datasetVersion"
    }
   ],
   "dockerImageVersionId": 30732,
   "isGpuEnabled": true,
   "isInternetEnabled": true,
   "language": "python",
   "sourceType": "notebook"
  },
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.10.13"
  },
  "papermill": {
   "default_parameters": {},
   "duration": 3443.641543,
   "end_time": "2024-06-23T13:26:38.883709",
   "environment_variables": {},
   "exception": null,
   "input_path": "__notebook__.ipynb",
   "output_path": "__notebook__.ipynb",
   "parameters": {},
   "start_time": "2024-06-23T12:29:15.242166",
   "version": "2.5.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
